<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ò–Ω—Ç–µ—Ä–≤—å—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–æ–ª–µ–π ‚Äî –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç—á—ë—Ç–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js">
    function toN8nJSON(data){
      // Very simplified generator: one trigger per first policy (CRON or email), steps as Code nodes
      const nodes = [];
      let id = 1;
      function nid(){ return (id++).toString(); }

      // Trigger (fallback to Cron every day 9:00)
      let trigger = { id: nid(), name:'Trigger', type:'n8n-nodes-base.cron', parameters:{ rule:'0 9 * * *' } };
      const emailPol = (data.policies||[]).find(p=> (p.channel||'').toLowerCase().includes('mail'));
      if(emailPol){
        trigger = { id: nid(), name:'Email Trigger', type:'n8n-nodes-base.imapTrigger', parameters:{} };
      }
      nodes.push(trigger);

      let prev = trigger.id;
      (data.tasks||[]).forEach((t,i)=>{
        const code = [
          `// ${t.title}`,
          `// Trigger: ${t.trigger}`,
          `// Steps: ${ (t.steps||[]).join(' | ') }`,
          `// Decisions: ${ (t.decisions||[]).join(' | ') }`,
          `// Exceptions: ${ t.exceptions||'' }`,
        ].join('\n');
        const node = { id:nid(), name:`Step ${i+1}: ${t.title||'Task'}`, type:'n8n-nodes-base.code', parameters:{ language:'javascript', code } };
        nodes.push(node);
      });

      // Simple notify at the end using SMTP if any policy exists
      const notify = { id:nid(), name:'Notify', type:'n8n-nodes-base.smtp', parameters:{ to:'owner@example.com', subject:'Workflow finished', text:'Done' } };
      nodes.push(notify);

      // Build linear connections
      const connections = {};
      function link(a,b){
        connections[a] = connections[a] || { main: [[]] };
        connections[a].main[0].push({ node:b, type:'main', index:0 });
      }
      let chain = [trigger.id].concat(nodes.filter(n=>n!==trigger && n.name.startsWith('Step')).map(n=>n.id)).concat([notify.id]);
      for(let i=0;i<chain.length-1;i++){ link(chain[i], chain[i+1]); }

      return { nodes, connections, meta: { generatedBy:'FlowXray', ts: new Date().toISOString() } };
    }

</script>
  <style>
    :root { --card: #0f172a; --ink: #e5e7eb; --muted:#9ca3af; --accent:#22d3ee; }
    html, body { background:#0b1020; color:var(--ink); }
    .card { background:var(--card); border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .chip { padding:.1rem .5rem; border:1px solid rgba(255,255,255,.1); border-radius:.5rem; font-size:.75rem; }
    .btn { background:#111827; border:1px solid rgba(255,255,255,.12); border-radius:.75rem; padding:.55rem .9rem; }
    .btn:hover { border-color:rgba(255,255,255,.25); }
    .btn-primary { background:linear-gradient(135deg,#22d3ee,#4ade80); color:#0b1020; font-weight:700 }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    @media (max-width: 900px){ .grid-2{ grid-template-columns: 1fr; } }
    textarea { min-height: 110px; }
    .kbd{border:1px solid rgba(255,255,255,.2); border-bottom-width:2px; border-radius:.5rem; padding:.05rem .4rem; font-weight:700; font-size:.75rem}
    .id-tag{font-size:.7rem; color:var(--muted)}
    .section-title{display:flex;align-items:center;gap:.6rem}
  
    .big{min-height:220px}
    .xl{min-height:320px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .wider input[type="text"], .wider textarea{font-size:0.95rem}
    .hint{font-size:.8rem;color:var(--muted)}
    
/* --- Responsive tables for mobile visibility --- */
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:.25rem -0.5rem 0;padding-bottom:.5rem}
.table-scroll table{min-width:780px}
.table-scroll::-webkit-scrollbar{height:8px}
.table-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18);border-radius:8px}
@media (max-width: 768px){
  .table-scroll th,.table-scroll td{white-space:nowrap}
}


.scroll-hint{font-size:.75rem;color:rgba(229,231,235,.7);padding:.2rem .4rem}
.table-scroll{position:relative}
.table-scroll::after{
  content:'‚Üî swipe';
  position:absolute;right:8px;top:4px;font-size:.75rem;
  color:rgba(229,231,235,.55);pointer-events:none;
}


/* --- Suggestion toolbar & modal --- */
.toolbar{display:flex;gap:.5rem;align-items:center;margin:.25rem 0}
.btn-ghost{background:transparent;border:1px dashed rgba(255,255,255,.22);padding:.35rem .6rem;border-radius:.6rem}
.btn-ghost:hover{border-color:rgba(255,255,255,.5)}
#suggestModal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:50}
#suggestModal .panel{background:#0b1220;border:1px solid #2a3142;border-radius:12px;max-width:680px;width:92%;max-height:80vh;overflow:auto;padding:14px}
#suggestList{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
#suggestList label{display:flex;gap:.5rem;align-items:center;background:#0f172a;border:1px solid #334155;border-radius:.5rem;padding:.4rem}
#suggestModal .panel .actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem}
.small-hint{font-size:.8rem;color:#cbd5e1}

</style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">–ò–Ω—Ç–µ—Ä–≤—å—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–æ–ª–µ–π</h1>
        <p class="text-sm text-gray-300">–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Ñ–∏—Å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤—å—é. –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON / Markdown / YAML. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button class="btn" onclick="saveDraft()" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ"><span>üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="loadDraft()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫"><span>üìÇ</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <label class="btn cursor-pointer" title="–ò–º–ø–æ—Ä—Ç JSON">
          üì• –ò–º–ø–æ—Ä—Ç JSON
          <input id="importFile" type="file" accept="application/json" class="hidden" onchange="importJSON(event)" />
        </label>
        <button class="btn btn-primary" onclick="exportAll()" title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="btn" onclick="window.print()" title="–ü–µ—á–∞—Ç—å / PDF">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
      </div>
    </header>

    <!-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–≥–ª–∞—Å–∏–µ -->
    <section class="card p-5 md:p-6 mb-5" id="sec-meta">
      <div class="section-title"><h2 class="text-xl font-semibold">1) –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–≥–ª–∞—Å–∏–µ</h2><span class="chip">–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</span></div>
      <div class="grid-2 mt-3">
        <div>
          <label class="block text-sm text-gray-300">–ö–æ–º–ø–∞–Ω–∏—è</label>
          <input id="company" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–û–û–û –ü—Ä–∏–º–µ—Ä"/>
        </div>
        <div>
          <label class="block text-sm text-gray-300">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ / –ö–æ–º–∞–Ω–¥–∞</label>
          <input id="dept" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–û—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂"/>
        </div>
        <div>
          <label class="block text-sm text-gray-300">–†–æ–ª—å / –î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
          <input id="role" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–ê–∫–∫–∞—É–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä"/>
        </div>
        <div>
          <label class="block text-sm text-gray-300">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ (–ø—Å–µ–≤–¥–æ–Ω–∏–º –¥–æ–ø—É—Å—Ç–∏–º)</label>
          <input id="employee" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–ò–≤–∞–Ω –ò."/>
        </div>
        <div>
          <label class="block text-sm text-gray-300">–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä</label>
          <input id="interviewer" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–û–ª–µ–≥ –¢."/>
        </div>
        <div>
          <label class="block text-sm text-gray-300">–î–∞—Ç–∞</label>
          <input id="date" type="date" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2"/>
        </div>
      </div>
      <div class="mt-3 flex flex-col gap-2">
        <label class="inline-flex items-center gap-2"><input id="consentRecord" type="checkbox" class="form-checkbox"/> <span>–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∑–∞–ø–∏—Å—å —Ç–µ–∫—Å—Ç–∞ –∏–Ω—Ç–µ—Ä–≤—å—é</span></label>
        <label class="inline-flex items-center gap-2"><input id="consentPII" type="checkbox" class="form-checkbox"/> <span>–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</span></label>
        <label class="inline-flex items-center gap-2"><input id="redact" type="checkbox" class="form-checkbox" checked/> <span>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å PII –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ (e‚Äëmail, —Ç–µ–ª–µ—Ñ–æ–Ω—ã)</span></label>
      </div>
    </section>

    <!-- –ö–∞–Ω–∞–ª—ã / –ò—Å—Ç–æ—á–Ω–∏–∫–∏ -->
    <section class="card p-5 md:p-6 mb-5" id="sec-channels">
      <div class="section-title"><h2 class="text-xl font-semibold">2) –ö–∞–Ω–∞–ª—ã –∏ —Å–∏—Å—Ç–µ–º—ã</h2><span class="chip">–≤—Ö–æ–¥—ã</span></div>
      <p class="text-sm text-gray-300 mt-1">–û—Ç–∫—É–¥–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é? –û—Ç–º–µ—Ç—å—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏.</p>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3" id="channelsBox"></div>
      <div class="mt-3 flex gap-2">
        <input id="customChannel" class="flex-1 bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–î—Ä—É–≥–æ–µ‚Ä¶"/>
        <button class="btn" onclick="addCustomChannel()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </section>

    <!-- –°–∏—Å—Ç–µ–º—ã ‚Äî –¥–µ—Ç–∞–ª–∏ -->
    <section class="card p-5 md:p-6 mb-5" id="sec-systems">
      <div class="section-title"><h2 class="text-xl font-semibold">2a) –°–∏—Å—Ç–µ–º—ã (–¥–µ—Ç–∞–ª–∏)</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-systems">
        <thead class="text-left text-gray-300"><tr><th class="py-1">–°–∏—Å—Ç–µ–º–∞</th><th>–¢–∏–ø</th><th>–í–ª–∞–¥–µ–ª–µ—Ü</th><th>–î–æ—Å—Ç—É–ø—ã</th><th>API</th><th>–õ–∏–º–∏—Ç—ã</th><th></th></tr></thead>
        <tbody id="systemsBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: systems-details</div>
      <button class="btn mt-3" onclick="addRow('systems')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- –ü–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π -->
    <section class="card p-5 md:p-6 mb-5" id="sec-policies">
      <div class="section-title"><h2 class="text-xl font-semibold">2b) –ü–æ–ª–∏—Ç–∏–∫–∏ –∫–∞–Ω–∞–ª–æ–≤</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <p class="text-sm text-gray-300 mt-1">SLA –∏ –∫–∞–¥–µ–Ω—Å—ã –ø–æ –∫–∞–Ω–∞–ª–∞–º –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π.</p>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-policies">
        <thead class="text-left text-gray-300"><tr><th class="py-1">–ö–∞–Ω–∞–ª</th><th>SLA –≤—Ö–æ–¥–∞</th><th>–ö–∞–¥–µ–Ω—Å —Ñ–æ–ª–ª–æ—É‚Äë–∞–ø–∞</th><th>–ú–∞–∫—Å. —Ä–µ—Ç—Ä–∞–µ–≤</th><th>–≠—Å–∫–∞–ª–∞—Ü–∏—è</th><th>–í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞</th><th>–¢–∞–π–º–∑–æ–Ω–∞</th><th></th></tr></thead>
        <tbody id="policiesBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: channel-policies</div>
      <button class="btn mt-3" onclick="addRow('policies')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>


    <!-- –í—Ö–æ–¥—ã -->
    <section class="card p-5 md:p-6 mb-5" id="sec-inputs">
      <div class="section-title"><h2 class="text-xl font-semibold">3) –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <p class="text-sm text-gray-300 mt-1">–ß—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ä–∞–±–æ—Ç—É: —Ñ–æ—Ä–º–∞—Ç, —á–∞—Å—Ç–æ—Ç–∞, —Å–∏—Å—Ç–µ–º–∞‚Äë–∏—Å—Ç–æ—á–Ω–∏–∫.</p>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-inputs">
        <thead class="text-left text-gray-300"><tr><th class="py-1">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫/–°–∏—Å—Ç–µ–º–∞</th><th>–§–æ—Ä–º–∞—Ç</th><th>–ß–∞—Å—Ç–æ—Ç–∞</th><th></th></tr></thead>
        <tbody id="inputsBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: timebox-inputs</div>
      <button class="btn mt-3" onclick="addRow('inputs')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- –í—ã—Ö–æ–¥—ã -->
    <section class="card p-5 md:p-6 mb-5" id="sec-outputs">
      <div class="section-title"><h2 class="text-xl font-semibold">4) –í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <p class="text-sm text-gray-300 mt-1">–ß—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∏ –∫—Ç–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å.</p>

      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-outputs">
        <thead class="text-left text-gray-300"><tr><th class="py-1">–ê—Ä—Ç–µ—Ñ–∞–∫—Ç</th><th>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å</th><th>–§–æ—Ä–º–∞—Ç/–®–∞–±–ª–æ–Ω</th><th>–ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è</th><th></th></tr></thead>
        <tbody id="outputsBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: deliverables-outputs</div>
      <button class="btn mt-3" onclick="addRow('outputs')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- –ó–∞–¥–∞—á–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã -->
    <section class="card p-5 md:p-6 mb-5" id="sec-tasks">
      <div class="section-title"><h2 class="text-xl font-semibold">5) –ó–∞–¥–∞—á–∏ –∏ –ø–æ—à–∞–≥–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã</h2><span class="chip">–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–µ</span></div>
      <p class="text-sm text-gray-300 mt-1">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∫–ª—é—á–µ–≤—ã–µ –∑–∞–¥–∞—á–∏. –î–ª—è –∫–∞–∂–¥–æ–π ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä, —à–∞–≥–∏, —Ä–∞–∑–≤–∏–ª–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.</p>
      <div id="tasksBox" class="flex flex-col gap-3 mt-3"></div>
      <button class="btn mt-2" onclick="addTask()">‚ûï –ó–∞–¥–∞—á–∞</button>
      <div class="flex items-center gap-2 mt-4">
        <select id="diagramTaskIdx" class="bg-gray-900 border border-gray-700 rounded-lg p-2">
          <option value="">(–≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã)</option>
        </select>

    <!-- LLM ‚Äî –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã -->
    <section class="card p-5 md:p-6 mb-5" id="sec-llm">
      <div class="section-title"><h2 class="text-xl font-semibold">6a) LLM ‚Äî —É—Ç–æ—á–Ω—è—é—â–∏–µ –ø–æ–¥–≤–æ–ø—Ä–æ—Å—ã</h2><span class="chip">OpenRouter</span></div>
      <p class="text-sm text-gray-300 mt-1">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤. –ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>
      <div class="grid-2 gap-3 mt-2">
        <div>
          <label class="text-sm text-gray-300">OpenRouter API Key</label>
          <input id="orKey" type="password" class="w-full bg-gray-900 border border-gray-700 rounded p-2" placeholder="sk-..." />
        </div>
        <div>
          <label class="text-sm text-gray-300">–ú–æ–¥–µ–ª—å</label>
          <input id="orModel" class="w-full bg-gray-900 border border-gray-700 rounded p-2" value="openrouter/auto" />
        </div>
      </div>
      <div class="mt-2">
        <label class="text-sm text-gray-300">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</label>
        <textarea id="orSys" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" rows="6">–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –ù–∞ –≤—Ö–æ–¥–µ: —Ä–æ–ª—å, —Å–ø–∏—Å–æ–∫ —Å–∏—Å—Ç–µ–º, –≤—Ö–æ–¥–æ–≤, –≤—ã—Ö–æ–¥–æ–≤ –∏ –æ–ø–∏—Å–∞–Ω–∏—è –∑–∞–¥–∞—á.
–¶–µ–ª—å: —Å–æ–±—Ä–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –∞–≥–µ–Ω—Ç–Ω–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä–∞ (n8n/Make) –∏ LLM‚Äë–∫–æ–ø–∏–ª–æ—Ç–∞.
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –¥–æ 5 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:
- –æ —à–∞–≥–∞—Ö (—á—Ç–æ –∫–ª–∏–∫–∞–µ–º/–≤–≤–æ–¥–∏–º/–∫–æ–ø–∏—Ä—É–µ–º, –ø–æ–ª—è/—Å–µ–ª–µ–∫—Ç–æ—Ä—ã, –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏)
- –æ –ø—Ä–∞–≤–∏–ª–∞—Ö (—Ñ–æ—Ä–º—É–ª—ã, –ø–æ—Ä–æ–≥–∏, –µ—Å–ª–∏‚Äë—Ç–æ)
- –æ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è—Ö (SLA, —Ñ–æ–ª–ª–æ—É‚Äë–∞–ø—ã, —ç—Å–∫–∞–ª–∞—Ü–∏–∏)
- –æ –¥–∞–Ω–Ω—ã—Ö (—Ñ–æ—Ä–º–∞—Ç—ã, —à–∞–±–ª–æ–Ω—ã, –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å)
- –æ–± –æ–±—ä—ë–º–∞—Ö (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è, –ø–∏–∫–∏)
–¢—Ä–µ–±—É–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã‚Äë–ø—Ä–∏–º–µ—Ä—ã. –£—á–∏—Ç—ã–≤–∞–π –∫–∞–Ω–∞–ª –∏ —Ä–æ–ª—å.</textarea>
      </div>
      <div class="mt-2 flex gap-2">
        <button class="btn" onclick="genFollowUps()">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã</button>
        <button class="btn" onclick="copyFollowUps()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <pre id="followUps" class="mt-3 whitespace-pre-wrap text-sm"></pre>
    </section>

        <button class="btn" onclick="buildDiagram()">üìà –î–∏–∞–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ (Mermaid)</button>
      </div>
      <div id="diagram" class="mt-3 card p-3 overflow-auto"></div>
      <div class="id-tag">genid: mermaid-main-01</div>
    </section>


    <!-- –ú–µ—Ç—Ä–∏–∫–∏ –æ–±—ä—ë–º–æ–≤/–≤—Ä–µ–º–µ–Ω–∏ -->
    <section class="card p-5 md:p-6 mb-5" id="sec-metrics">
      <div class="section-title"><h2 class="text-xl font-semibold">7a) –ú–µ—Ç—Ä–∏–∫–∏ –æ–±—ä—ë–º–æ–≤/–≤—Ä–µ–º–µ–Ω–∏</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-metrics">
        <thead class="text-left text-gray-300"><tr><th class="py-1">–ú–µ—Ç—Ä–∏–∫–∞</th><th>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</th><th>–ï–¥–∏–Ω–∏—Ü—ã</th><th>–ö–∞–∫ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è</th><th></th></tr></thead>
        <tbody id="metricsBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: volume-metrics</div>
      <button class="btn mt-3" onclick="addRow('metrics')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è / RACI -->
    <section class="card p-5 md:p-6 mb-5" id="sec-raci">
      <div class="section-title"><h2 class="text-xl font-semibold">6) –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∏ RACI</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-raci">
        <thead class="text-left text-gray-300"><tr><th class="py-1">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (–ª—é–¥–∏/—Å–∏—Å—Ç–µ–º—ã)</th><th>–¢–∏–ø –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è</th><th>R/A/C/I</th><th>–ö–∞–Ω–∞–ª</th><th></th></tr></thead>
        <tbody id="raciBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: raci-matrix</div>
      <button class="btn mt-3" onclick="addRow('raci')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- –í—Ä–µ–º—è –∏ —á–∞—Å—Ç–æ—Ç–∞ -->
    <section class="card p-5 md:p-6 mb-5" id="sec-time">
      <div class="section-title"><h2 class="text-xl font-semibold">7) –¢–∞–π–º-–∞—É–¥–∏—Ç</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <p class="text-sm text-gray-300">–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —É—Ö–æ–¥–∏—Ç –Ω–∞ –∑–∞–¥–∞—á–∏? –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.</p>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-time">
        <thead class="text-left text-gray-300"><tr><th class="py-1">–ó–∞–¥–∞—á–∞</th><th>–ß–∞—Å—Ç–æ—Ç–∞</th><th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</th><th>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ–º–æ—Å—Ç—å (0‚Äì100)</th><th></th></tr></thead>
        <tbody id="timeBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: time-audit</div>
      <div class="mt-3 text-sm">–í—Å–µ–≥–æ –º–∏–Ω—É—Ç/–Ω–µ–¥–µ–ª—è: <span id="timeTotal" class="font-bold">0</span></div>
      <button class="btn mt-3" onclick="addRow('time')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- –ü—Ä–∞–≤–∏–ª–∞, —Ä–∏—Å–∫–∏, –º–µ—Ç—Ä–∏–∫–∏ -->
    <section class="card p-5 md:p-6 mb-5" id="sec-rules">
      <div class="grid-2 gap-3">
        <div>
          <div class="section-title"><h2 class="text-xl font-semibold">8) –ë–∏–∑–Ω–µ—Å‚Äë–ø—Ä–∞–≤–∏–ª–∞ –∏ –ø–æ–ª–∏—Ç–∏–∫–∏</h2></div>
          <textarea id="rules" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏, SLA, —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π, —Ñ–æ—Ä–º—É–ª—ã —Ä–∞—Å—á—ë—Ç–æ–≤‚Ä¶" class="big"></textarea>
        </div>
        <div>
          <div class="section-title"><h2 class="text-xl font-semibold">9) –†–∏—Å–∫–∏, –æ—à–∏–±–∫–∏, –∏—Å–∫–ª—é—á–µ–Ω–∏—è</h2></div>
          <textarea id="risks" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–¢–∏–ø–æ–≤—ã–µ —Å–±–æ–∏, —Ä—É—á–Ω—ã–µ –æ–±—Ö–æ–¥—ã, —Ç–æ—á–∫–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏‚Ä¶" class="big"></textarea>
        </div>
      </div>
      <div class="grid-2 gap-3 mt-3">
        <div>
          <div class="section-title"><h2 class="text-xl font-semibold">10) –ú–µ—Ç—Ä–∏–∫–∏ / KPI</h2></div>
          <textarea id="kpis" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞, –∫–æ–Ω–≤–µ—Ä—Å–∏—è, —Ç–æ—á–Ω–æ—Å—Ç—å, NPS‚Ä¶" class="big"></textarea>

    <!-- –û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ -->
    <section class="card p-5 md:p-6 mb-5" id="sec-readiness">
      <div class="section-title"><h2 class="text-xl font-semibold">7b) –û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (—Å–∫oring)</h2><span class="chip">0‚Äì100</span></div>
      <div class="grid-2 gap-3 mt-3">
        <div>
          <label class="text-sm text-gray-300">–û–±—ä—ë–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —à–∞–≥–æ–≤ (–≤–µ—Å 0.3)</label>
          <input id="scoreVolume" type="range" min="0" max="100" value="50" class="w-full" oninput="updateReadiness()" />
        </div>
        <div>
          <label class="text-sm text-gray-300">–§–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–∞–≤–∏–ª (–≤–µ—Å 0.25)</label>
          <input id="scoreRules" type="range" min="0" max="100" value="50" class="w-full" oninput="updateReadiness()" />
        </div>
        <div>
          <label class="text-sm text-gray-300">–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π (–≤–µ—Å 0.2)</label>
          <input id="scoreAPI" type="range" min="0" max="100" value="50" class="w-full" oninput="updateReadiness()" />
        </div>
        <div>
          <label class="text-sm text-gray-300">SLA –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ (–≤–µ—Å 0.15)</label>
          <input id="scoreSLA" type="range" min="0" max="100" value="50" class="w-full" oninput="updateReadiness()" />
        </div>
        <div>
          <label class="text-sm text-gray-300">–†–∏—Å–∫–∏ –∏ –∫–æ–º–ø–ª–∞–µ–Ω—Å (–≤–µ—Å 0.1, –Ω–∏–∑–∫–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å = –≤—ã—à–µ)</label>
          <input id="scoreRisk" type="range" min="0" max="100" value="50" class="w-full" oninput="updateReadiness()" />
        </div>
      </div>
      <div class="mt-3 text-sm">–°—É–º–º–∞—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞: <span id="readinessScore" class="font-bold">0</span> / 100</div>
    </section>

    <!-- –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏ –ø—Ä–∏–º–µ—Ä—ã -->
    <section class="card p-5 md:p-6 mb-5" id="sec-artifacts, entities, errors, volumes, deps, creds">
      <div class="section-title"><h2 class="text-xl font-semibold">16) –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã‚Äë–ø—Ä–∏–º–µ—Ä—ã</h2><span class="chip">—Ñ–∞–π–ª—ã/—Å—Å—ã–ª–∫–∏</span></div>
      <p class="text-sm text-gray-300">–£–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —à–∞–±–ª–æ–Ω—ã, —Ñ–∞–π–ª—ã, –¥–µ–º–æ‚Äë–≤–∏–¥–µ–æ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è (PII –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è).</p>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-artifacts, entities, errors, volumes, deps, creds">
        <thead class="text-left text-gray-300"><tr><th class="py-1">–¢–∏–ø</th><th>–§–∞–π–ª/–°—Å—ã–ª–∫–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th></th></tr></thead>
        <tbody id="artifacts, entities, errors, volumes, deps, credsBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: artifacts, entities, errors, volumes, deps, creds</div>
      <button class="btn mt-3" onclick="addRow('artifacts, entities, errors, volumes, deps, creds')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

        </div>
        <div>
          <div class="section-title"><h2 class="text-xl font-semibold">11) –î–æ—Å—Ç—É–ø—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2></div>
          <textarea id="security" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–†–æ–ª–∏, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, —Ä–µ—Ç–µ–Ω—Ü–∏—è, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (GDPR)‚Ä¶" class="big"></textarea>
        </div>
        </div>
      </div>
    </section>

      </div>
    </section>

    <!-- –î–µ–Ω—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ / –ø—Ä–∏–º–µ—Ä—ã -->
    <section class="card p-5 md:p-6 mb-5" id="sec-day">
      <div class="grid-2 gap-3">
        <div>
          <div class="section-title"><h2 class="text-xl font-semibold">12) –î–µ–Ω—å –∏–∑ –∂–∏–∑–Ω–∏ (—Ç–∞–π–º–ª–∞–π–Ω)</h2></div>
          <textarea id="day" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Ç–∏–ø–∏—á–Ω–æ–≥–æ –¥–Ω—è: 09:00 –ø—Ä–æ–≤–µ—Ä–∫–∞ CRM ‚Üí 09:30 –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞–º‚Ä¶" class="big"></textarea>
        </div>
        <div>
          <div class="section-title"><h2 class="text-xl font-semibold">13) –ù–µ–¥–∞–≤–Ω–∏–µ 5 –∫–µ–π—Å–æ–≤</h2></div>
          <textarea id="cases" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–¥–∞—á, –∑–∞—á–µ–º, –∫–∞–∫ —Ä–µ—à–∞–ª–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Ä¶" class="big"></textarea>
        </div>
      </div>
    </section>

    <!-- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã -->
    <section class="card p-5 md:p-6 mb-6" id="sec-auto">
      <div class="grid-2 gap-3">
        <div>
          <div class="section-title"><h2 class="text-xl font-semibold">14) –ò–¥–µ–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏</h2></div>
          <textarea id="automation" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="RPA, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, AI‚Äë–∫–æ–ø–∏–ª–æ—Ç—ã, —à–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤, –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ‚Ä¶" class="big"></textarea>
        </div>
        <div>
          <div class="section-title"><h2 class="text-xl font-semibold">15) –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ –æ—Ü–µ–Ω–∫–∞</h2></div>
          <textarea id="priorities" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2" placeholder="–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å, –æ–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç‚Ä¶" class="big"></textarea>
        </div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button class="btn" onclick="previewMarkdown()">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞</button>
        <button class="btn btn-primary" onclick="exportAll()">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON / MD / YAML</button>
      </div>
    </section>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞ -->
    <section class="card p-5 md:p-6 mb-10 hidden" id="sec-preview">
      <div class="section-title"><h2 class="text-xl font-semibold">üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä Markdown‚Äë–æ—Ç—á—ë—Ç–∞</h2><span class="chip">read‚Äëonly</span></div>
      <pre id="mdPreview" class="mt-3 whitespace-pre-wrap text-sm"></pre>
    </section>
    <!-- Data Entities & Lineage -->
    <section class="card p-5 md:p-6 mb-5" id="sec-entities">
      <div class="section-title"><h2 class="text-xl font-semibold">2c) –ö–∞—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–æ</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <p class="text-sm text-gray-300 mt-1">–û–ø–∏—à–∏—Ç–µ –¥–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏, —Å–∏—Å—Ç–µ–º—É-–∏—Å—Ç–æ—á–Ω–∏–∫ (SoR), –≤–ª–∞–¥–µ–Ω–∏–µ CRUD, PII/—Ä–µ—Ç–µ–Ω—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞.</p>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-entities">
        <thead class="text-left text-gray-300">
          <tr>
            <th class="py-1">–°—É—â–Ω–æ—Å—Ç—å</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°–∏—Å—Ç–µ–º–∞-–∏—Å—Ç–æ—á–Ω–∏–∫</th><th>CRUD-–≤–ª–∞–¥–µ–ª–µ—Ü</th><th>PII –∫–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–†–µ—Ç–µ–Ω—Ü–∏—è</th><th>–ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞</th><th></th>
          </tr>
        </thead>
        <tbody id="entitiesBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: data-entities</div>
      <button class="btn mt-3" onclick="addRow('entities')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- Error Handling Matrix -->
    <section class="card p-5 md:p-6 mb-5" id="sec-errors">
      <div class="section-title"><h2 class="text-xl font-semibold">5c) –ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫ –∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <p class="text-sm text-gray-300 mt-1">–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —Ç–∏–ø–æ–≤—ã–µ —Å–±–æ–∏, –∫–∞–∫ –æ–Ω–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è, –ø—É—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –∫–æ–≥–æ —É–≤–µ–¥–æ–º–ª—è—Ç—å.</p>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-errors">
        <thead class="text-left text-gray-300">
          <tr><th class="py-1">–°—Ü–µ–Ω–∞—Ä–∏–π –æ—à–∏–±–∫–∏</th><th>–î–µ—Ç–µ–∫—Ü–∏—è</th><th>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</th><th>–≠—Å–∫–∞–ª–∞—Ü–∏—è/–≤–ª–∞–¥–µ–ª–µ—Ü</th><th>–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è</th><th></th></tr>
        </thead>
        <tbody id="errorsBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: error-matrix</div>
      <button class="btn mt-3" onclick="addRow('errors')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- Volume & Seasonality -->
    <section class="card p-5 md:p-6 mb-5" id="sec-volume">
      <div class="section-title"><h2 class="text-xl font-semibold">7c) –û–±—ä—ë–º—ã –∏ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <p class="text-sm text-gray-300 mt-1">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º –∏ –ø–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏.</p>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-volume">
        <thead class="text-left text-gray-300">
          <tr><th class="py-1">–ï–¥–∏–Ω–∏—Ü–∞</th><th>–í –¥–µ–Ω—å</th><th>–í –Ω–µ–¥–µ–ª—é</th><th>–í –º–µ—Å—è—Ü</th><th>–ü–∏–∫–æ–≤—ã–µ –º–µ—Å—è—Ü—ã/—á–∞—Å—ã</th><th></th></tr>
        </thead>
        <tbody id="volumeBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: volume-distribution</div>
      <button class="btn mt-3" onclick="addRow('volume')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- Dependencies / Vendors -->
    <section class="card p-5 md:p-6 mb-5" id="sec-deps">
      <div class="section-title"><h2 class="text-xl font-semibold">8b) –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø–æ–¥—Ä—è–¥—á–∏–∫–∏</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <p class="text-sm text-gray-300 mt-1">–°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –≤–Ω–µ—à–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ (SLA, –∫–æ–Ω—Ç–∞–∫—Ç—ã, —Ä–∏—Å–∫–∏).</p>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-deps">
        <thead class="text-left text-gray-300">
          <tr><th class="py-1">–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å/–í–µ–Ω–¥–æ—Ä</th><th>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</th><th>SLA/–ö–æ–Ω—Ç—Ä–∞–∫—Ç</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th>–†–∏—Å–∫</th><th></th></tr>
        </thead>
        <tbody id="depsBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: dependencies</div>
      <button class="btn mt-3" onclick="addRow('deps')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- Credentials & Env Map -->
    <section class="card p-5 md:p-6 mb-5" id="sec-creds">
      <div class="section-title"><h2 class="text-xl font-semibold">11a) –ö–∞—Ä—Ç–∞ –¥–æ—Å—Ç—É–ø–æ–≤ –∏ —Å–µ–∫—Ä–µ—Ç–æ–≤</h2><span class="chip">—Ç–∞–±–ª–∏—Ü–∞</span></div>
      <p class="text-sm text-gray-300 mt-1">–ö–∞–∫–æ–π —É–∑–µ–ª n8n –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–∞–∫–∏–µ –∫—Ä–µ–¥–µ–Ω—à–µ–ª—ã. –£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–æ–ª–∏—Ç–∏–∫—É —Ä–æ—Ç–∞—Ü–∏–∏.</p>
      <div class="table-scroll"><table class="w-full text-sm mt-3" id="tbl-creds">
        <thead class="text-left text-gray-300">
          <tr><th class="py-1">–°–∏—Å—Ç–µ–º–∞/–£–∑–µ–ª</th><th>Credential name</th><th>–•—Ä–∞–Ω–µ–Ω–∏–µ</th><th>–†–æ—Ç–∞—Ü–∏—è</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th><th></th></tr>
        </thead>
        <tbody id="credsBody"></tbody>
      </table></div>
      <div class="id-tag mt-1">table-id: credentials-map</div>
      <button class="btn mt-3" onclick="addRow('creds')">‚ûï –°—Ç—Ä–æ–∫–∞</button>
    </section>

    <!-- Communication Playbooks -->
    <section class="card p-5 md:p-6 mb-5" id="sec-playbooks">
      <div class="section-title"><h2 class="text-xl font-semibold">6b) –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–ª–µ–π–±—É–∫–∏</h2><span class="chip">—Ç–µ–∫—Å—Ç</span></div>
      <p class="text-sm text-gray-300 mt-1">–®–∞–±–ª–æ–Ω—ã –ø–∏—Å–µ–º/—Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø—Ä–∏–º–µ—Ä—ã —Ñ–æ–ª–ª–æ—É‚Äë–∞–ø–æ–≤ –¥–ª—è –∫–æ–ø–∏–ª–æ—Ç–∞.</p>
      <textarea id="playbooks" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 big mono" placeholder="–®–∞–±–ª–æ–Ω –æ—Ç–≤–µ—Ç–∞ A...
–®–∞–±–ª–æ–Ω —ç—Å–∫–∞–ª–∞—Ü–∏–∏ B...
–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π..."></textarea>
    </section>

    <!-- Copilot Guardrails -->
    <section class="card p-5 md:p-6 mb-5" id="sec-guardrails">
      <div class="section-title"><h2 class="text-xl font-semibold">6c) –ü—Ä–∞–≤–∏–ª–∞ –∫–æ–ø–∏–ª–æ—Ç–∞ (guardrails)</h2><span class="chip">—Ç–µ–∫—Å—Ç</span></div>
      <p class="text-sm text-gray-300 mt-1">–ß—Ç–æ –∫–æ–ø–∏–ª–æ—Ç—É –º–æ–∂–Ω–æ/–Ω–µ–ª—å–∑—è, –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å—Ç–∏–Ω—ã, –∑–∞–ø—Ä–µ—Ç–Ω—ã–µ —Ç–µ–º—ã, —Ç–æ–Ω.</p>
      <textarea id="guardrails" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 big" placeholder="–î–µ–ª–∞—Ç—å: ...
–ù–µ –¥–µ–ª–∞—Ç—å: ...
–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: ...
–¢–æ–Ω: ..."></textarea>
    </section>


    <footer class="text-xs text-gray-400 mb-8">
      –ü–æ–¥—Å–∫–∞–∑–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <span class="kbd">Tab</span> / <span class="kbd">Shift+Tab</span> –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–≤–æ–¥–∞ –ø–æ –ø–æ–ª—è–º. –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç –ø–æ–¥–ø–∏—Å—å –≤–∏–¥–∞ <span class="chip">table-id</span>, –¥–∏–∞–≥—Ä–∞–º–º–∞ ‚Äî <span class="chip">genid</span>.
    </footer>
  </div>

  <script>
    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mermaid ---
    mermaid.initialize({ startOnLoad: false, theme: 'dark' });

    // --- –ù–∞—á–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã ---
    const defaultChannels = ['Email','CRM','ERP','Slack/Teams','–¢–µ–ª–µ—Ñ–æ–Ω','Zoom/Meet','SharePoint/Drive','Git/Code','API','–§–æ—Ä–º—ã —Å–∞–π—Ç–∞','–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö','1C','Ticketing/Jira','Calendars','Paper'];

    const SKEY = 'interviewDraft-v1';

    function qs(id){ return document.getElementById(id); }

    function addCustomChannel(){
      const val = qs('customChannel').value.trim();
      if(!val) return; addChannelChip(val); qs('customChannel').value='';
    }

    function addChannelChip(name, checked=false){
      const box = qs('channelsBox');
      const id = 'chan-' + name.toLowerCase().replace(/[^a-z0-9]+/gi,'-');
      const wrap = document.createElement('label');
      wrap.className = 'inline-flex items-center gap-2 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2';
      wrap.innerHTML = `<input type="checkbox" class="form-checkbox" id="${id}" ${checked?'checked':''}/> <span>${name}</span>`;
      wrap.dataset.name = name;
      box.appendChild(wrap);
    }

    // –¢–∞–±–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    function addRow(kind, data={}){
      if(kind==='inputs'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.name||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.source||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.format||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.freq||''}"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        qs('inputsBody').appendChild(tr);
      }
      if(kind==='outputs'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.art||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.consumer||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.format||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.store||''}"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        qs('outputsBody').appendChild(tr);
      }
      if(kind==='systems'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.name||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.type||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.owner||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.access||''}"></td>
                        <td><select class="w-full bg-gray-900 border border-gray-700 rounded p-1"><option ${data.api==='yes'?'selected':''}>yes</option><option ${data.api==='no'?'selected':''}>no</option></select></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.rate_limits||data.limits||''}"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        qs('systemsBody').appendChild(tr);
      }
      if(kind==='policies'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.channel||''}\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.inbound_sla||''}\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.followup_cadence||data.cadence||''}\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" type=\"number\" min=\"0\" value=\"${(data.max_retries??data.retries)??''}\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.escalation_path||data.escalation||''}\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.quiet_hours||data.quiet||''}\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.tz||''}\"></td>
                        <td><button class=\"btn\" onclick=\"this.closest('tr').remove()\">‚úñ</button></td>`;
        qs('policiesBody').appendChild(tr);
      }
      if(kind==='raci'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.party||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.type||''}"></td>
                        <td><select class="w-full bg-gray-900 border border-gray-700 rounded p-1">
                              <option ${data.raci==='R'?'selected':''}>R</option>
                              <option ${data.raci==='A'?'selected':''}>A</option>
                              <option ${data.raci==='C'?'selected':''}>C</option>
                              <option ${data.raci==='I'?'selected':''}>I</option>
                            </select></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.channel||''}"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        qs('raciBody').appendChild(tr);
      }
      if(kind==='time'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1 taskname" value="${data.task||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1 freq" value="${data.freq||''}" placeholder="–µ–∂–µ–¥–Ω–µ–≤–Ω–æ/–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ‚Ä¶"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1 mins" type="number" value="${data.mins||0}" min="0"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1 score" type="number" value="${data.score||0}" min="0" max="100"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove(); recalcTime()">‚úñ</button></td>`;
        qs('timeBody').appendChild(tr);
        tr.querySelector('.mins').addEventListener('input', recalcTime);
      }
      if(kind==='metrics'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.metric||''}\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.definition||''}\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.units||''}\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.method||''}\"></td>
                        <td><button class=\"btn\" onclick=\"this.closest('tr').remove()\">‚úñ</button></td>`;
        qs('metricsBody').appendChild(tr);
      }
      if(kind==='artifacts, entities, errors, volumes, deps, creds'){
      // --- Added: new dynamic table rows ---
      if(kind==='entities'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–ö–ª–∏–µ–Ω—Ç" value="${data.entity||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–ß—Ç–æ —ç—Ç–æ?" value="${data.desc||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="CRM/ERP" value="${data.sor||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–ö—Ç–æ –º–µ–Ω—è–µ—Ç?" value="${data.crud_owner||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="none/basic/sensitive" value="${data.pii||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="12m/36m/..." value="${data.retention||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–≤–∞–ª–∏–¥–∞—Ü–∏–∏/–¥–µ–¥—É–ø" value="${data.quality||''}"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        qs('entitiesBody').appendChild(tr);
      }
      if(kind==='errors'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.case||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.detect||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.recover||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.owner||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.notify||''}"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        qs('errorsBody').appendChild(tr);
      }
      if(kind==='volume'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–ø–∏—Å—å–º–∞/–∑–≤–æ–Ω–∫–∏/—Ç–∏–∫–µ—Ç—ã" value="${data.item||''}"></td>
                        <td><input type="number" min="0" class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.day||''}"></td>
                        <td><input type="number" min="0" class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.week||''}"></td>
                        <td><input type="number" min="0" class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.month||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–¥–µ–∫–∞–±—Ä—å, 9‚Äì11" value="${data.peaks||''}"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        qs('volumeBody').appendChild(tr);
      }
      if(kind==='deps'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.dep||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.purpose||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.sla||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.contact||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.risk||''}"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        qs('depsBody').appendChild(tr);
      }
      if(kind==='creds'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="CRM node" value="${data.node||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="CRM_API_KEY" value="${data.cred||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="n8n creds store/Vault" value="${data.store||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="90d" value="${data.rotate||''}"></td>
                        <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${data.note||''}"></td>
                        <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        qs('credsBody').appendChild(tr);
      }

        const tr = document.createElement('tr');
        tr.innerHTML = `<td><select class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\"><option ${data.type==='email'?'selected':''}>email</option><option ${data.type==='excel'?'selected':''}>excel</option><option ${data.type==='pdf'?'selected':''}>pdf</option><option ${data.type==='code'?'selected':''}>code</option><option ${data.type==='cad'?'selected':''}>cad</option><option ${data.type==='other'?'selected':''}>other</option></select></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.fileRef||''}\" placeholder=\"–∏–º—è —Ñ–∞–π–ª–∞ –∏–ª–∏ —Å—Å—ã–ª–∫–∞\"></td>
                        <td><input class=\"w-full bg-gray-900 border border-gray-700 rounded p-1\" value=\"${data.description||''}\"></td>
                        <td><button class=\"btn\" onclick=\"this.closest('tr').remove()\">‚úñ</button></td>`;
        qs('artifacts, entities, errors, volumes, deps, credsBody').appendChild(tr);
      }
    }

    // –ó–∞–¥–∞—á–∏
    let taskCount = 0;
    function addTask(data={}){
      const idx = taskCount++;
      const wrap = document.createElement('div');
      wrap.className = 'card p-4';
      wrap.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="font-semibold">–ó–∞–¥–∞—á–∞ #${idx+1}</div>
          <div class="flex gap-2">
            <button class="btn" onclick="this.closest('.card').remove(); rebuildDiagramSelector()">‚úñ –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
        <div class="grid-2 gap-3 mt-2">
          <div>
            <label class="text-sm text-gray-300">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input class="w-full bg-gray-900 border border-gray-700 rounded p-2 task-title" value="${data.title||''}">
          </div>
          <div>
            <label class="text-sm text-gray-300">–¢—Ä–∏–≥–≥–µ—Ä</label>
            <input class="w-full bg-gray-900 border border-gray-700 rounded p-2 task-trigger" value="${data.trigger||''}" placeholder="–ü–æ—Å—Ç—É–ø–∏–ª –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ / —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è‚Ä¶">
          </div>
        </div>
        <div class="grid-2 gap-3 mt-2">
          <div>
            <label class="text-sm text-gray-300">–®–∞–≥–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
            <textarea class="w-full bg-gray-900 border border-gray-700 rounded p-2 task-steps" placeholder="1. –û—Ç–∫—Ä—ã—Ç—å CRM\n2. –ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞‚Ä¶">${data.steps||''}</textarea>
          </div>
          <div>
            <label class="text-sm text-gray-300">–†–∞–∑–≤–∏–ª–∫–∏ / –†–µ—à–µ–Ω–∏—è</label>
            <textarea class="w-full bg-gray-900 border border-gray-700 rounded p-2 task-decisions" placeholder="–ï—Å–ª–∏ A ‚Äî –¥–µ–ª–∞–µ–º X, –∏–Ω–∞—á–µ Y">${data.decisions||''}</textarea>
          </div>
        </div>
        <div class="grid-2 gap-3 mt-2">
          <div>
            <label class="text-sm text-gray-300">–ò—Å–∫–ª—é—á–µ–Ω–∏—è / –û—à–∏–±–∫–∏</label>
            <textarea class="w-full bg-gray-900 border border-gray-700 rounded p-2 task-exc" placeholder="–ß—Ç–æ –¥–µ–ª–∞–µ–º –ø—Ä–∏ —Å–±–æ—è—Ö?">${data.exc||''}</textarea>
          </div>
          <div>
            <label class="text-sm text-gray-300">SLA / –°—Ä–æ–∫–∏</label>
            <input class="w-full bg-gray-900 border border-gray-700 rounded p-2 task-sla" value="${data.sla||''}">
          </div>
        </div>
        <div class="mt-2">
          <label class="text-sm text-gray-300">UI –ø–æ–¥—Å–∫–∞–∑–∫–∏ (URL; —Å–µ–ª–µ–∫—Ç–æ—Ä—ã; –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏; –æ–∂–∏–¥–∞–Ω–∏—è)</label>
          <textarea class="w-full bg-gray-900 border border-gray-700 rounded p-2 task-ui" placeholder="URL=/app/orders; —Å–µ–ª–µ–∫—Ç–æ—Ä—ã=.btn-submit; –∫–ª–∞–≤–∏—à–∏=Ctrl+K; –æ–∂–∏–¥–∞–Ω–∏—è=spinner 3s">${data.ui || (Array.isArray(data.ui_hints)? data.ui_hints.join('\n') : '')}</textarea>
        </div>
      `;
      qs('tasksBox').appendChild(wrap);
      rebuildDiagramSelector();
    }

    function rebuildDiagramSelector(){
      const sel = qs('diagramTaskIdx');
      sel.innerHTML = '<option value="">(–≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã)</option>';
      const cards = [...qs('tasksBox').querySelectorAll('.card')];
      cards.forEach((c,i)=>{
        const title = c.querySelector('.task-title')?.value||`–ó–∞–¥–∞—á–∞ ${i+1}`;
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = `${i+1}) ${title}`; sel.appendChild(opt);
      });
    }

    function buildDiagram(){
      const idx = parseInt(qs('diagramTaskIdx').value);
      if(isNaN(idx)) { qs('diagram').innerHTML = '<div class="text-sm text-red-300">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É.</div>'; return; }
      const card = qs('tasksBox').querySelectorAll('.card')[idx];
      const title = card.querySelector('.task-title').value || `–ó–∞–¥–∞—á–∞ ${idx+1}`;
      const steps = (card.querySelector('.task-steps').value||'').split(/\n+/).map(s=>s.replace(/^\d+\.\s*/,'').trim()).filter(Boolean);
      const decisions = (card.querySelector('.task-decisions').value||'').split(/\n+/).filter(Boolean);

      let flow = `flowchart TD\nA([${escapeMermaid(title)}])`;
      let prev = 'A';
      steps.forEach((s, i)=>{
        const id = 'S'+i; flow += `\n${id}([${escapeMermaid(s)}])`; flow += `\n${prev}-->${id}`; prev=id;
      });
      decisions.forEach((d, i)=>{
        const id = 'D'+i; flow += `\n${id}{${escapeMermaid(d)}}`; flow += `\n${prev}-->${id}`; prev=id;
      });
      flow += '\n';

      qs('diagram').innerHTML = `<div class="mermaid">${flow}</div>`;
      mermaid.run({ nodes: [qs('diagram')] });
    }

    function escapeMermaid(s){ return s.replace(/[\[\]{}()<>]/g,'').replace(/"/g,'\"'); }

    function collectTable(tbody){
      const rows = [...tbody.querySelectorAll('tr')];
      return rows.map(tr=>{
        const inputs = [...tr.querySelectorAll('input,select')];
        return inputs.map(i=>i.value);
      });
    }

    function recalcTime(){
      const mins = [...qs('timeBody').querySelectorAll('.mins')].map(i=>parseInt(i.value||0)||0);
      const total = mins.reduce((a,b)=>a+b,0);
      qs('timeTotal').textContent = total;
    }

    function redactPII(text){
      if(!qs('redact').checked) return text;
      // e‚Äëmail
      text = text.replace(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi,'[redacted-email]');
      // —Ç–µ–ª–µ—Ñ–æ–Ω—ã (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
      text = text.replace(/\+?\d[\d\s().-]{6,}\d/g,'[redacted-phone]');
      return text;
    }

    function gather(){
      const channels = [...qs('channelsBox').querySelectorAll('label')]
        .filter(l=>l.querySelector('input').checked).map(l=>l.dataset.name);

      const inputs = collectTable(qs('inputsBody')).map(r=>({name:r[0], source:r[1], format:r[2], freq:r[3]}));
      const outputs = collectTable(qs('outputsBody')).map(r=>({art:r[0], consumer:r[1], format:r[2], store:r[3]}));
      const systems = collectTable(qs('systemsBody')).map(r=>({name:r[0], type:r[1], owner:r[2], access:r[3], api:r[4], rate_limits:r[5]}));
      const policies = collectTable(qs('policiesBody')).map(r=>({channel:r[0], inbound_sla:r[1], followup_cadence:r[2], max_retries:Number(r[3]||0), escalation_path:r[4], quiet_hours:r[5], tz:r[6]}));
      const metrics = collectTable(qs('metricsBody')).map(r=>({metric:r[0], definition:r[1], units:r[2], method:r[3]}));
      const raci = collectTable(qs('raciBody')).map(r=>({party:r[0], type:r[1], raci:r[2], channel:r[3]}));
      const time = collectTable(qs('timeBody')).map(r=>({task:r[0], freq:r[1], mins:Number(r[2]||0), score:Number(r[3]||0)}));
      const artifacts, entities, errors, volumes, deps, creds = collectTable(qs('artifacts, entities, errors, volumes, deps, credsBody')).map(r=>({type:r[0], fileRef:r[1], description:r[2]}));

      const entities = collectTable(qs('entitiesBody')).map(r=>({entity:r[0], desc:r[1], sor:r[2], crud_owner:r[3], pii:r[4], retention:r[5], quality:r[6]}));
      const errors = collectTable(qs('errorsBody')).map(r=>({case:r[0], detect:r[1], recover:r[2], owner:r[3], notify:r[4]}));
      const volumes = collectTable(qs('volumeBody')).map(r=>({item:r[0], day:Number(r[1]||0), week:Number(r[2]||0), month:Number(r[3]||0), peaks:r[4]}));
      const deps = collectTable(qs('depsBody')).map(r=>({dep:r[0], purpose:r[1], sla:r[2], contact:r[3], risk:r[4]}));
      const creds = collectTable(qs('credsBody')).map(r=>({node:r[0], cred:r[1], store:r[2], rotate:r[3], note:r[4]}));


      const tasks = [...qs('tasksBox').querySelectorAll('.card')].map(c=>({
        title: c.querySelector('.task-title').value,
        trigger: c.querySelector('.task-trigger').value,
        steps: (c.querySelector('.task-steps').value||'').split(/\n+/).filter(Boolean),
        decisions: (c.querySelector('.task-decisions').value||'').split(/\n+/).filter(Boolean),
        exceptions: c.querySelector('.task-exc').value,
        sla: c.querySelector('.task-sla').value,
        ui_hints: (c.querySelector('.task-ui').value||'').split(/\n+/).filter(Boolean)
      }));

      const data = {
        meta: {
          company: qs('company').value,
          dept: qs('dept').value,
          role: qs('role').value,
          employee: qs('employee').value,
          interviewer: qs('interviewer').value,
          date: qs('date').value,
          consentRecord: qs('consentRecord').checked,
          consentPII: qs('consentPII').checked,
          redact: qs('redact').checked,
        },
        channels, systems, inputs, outputs, tasks, raci, time, policies, metrics, artifacts, entities, errors, volumes, deps, creds,
        rules: qs('rules').value,
        risks: qs('risks').value,
        kpis: qs('kpis').value,
        security: qs('security').value,
        day: qs('day').value,
        cases: qs('cases').value,
        automation: qs('automation').value,
        priorities: qs('priorities').value,
        readiness: {
          sliders: {
            volume: Number(qs('scoreVolume')?.value||0),
            rules: Number(qs('scoreRules')?.value||0),
            api: Number(qs('scoreAPI')?.value||0),
            sla: Number(qs('scoreSLA')?.value||0),
            risk: Number(qs('scoreRisk')?.value||0)
          },
          total: Number(qs('readinessScore')?.textContent||0)
        }
      };

      // –†–µ–¥–∞–∫—Ü–∏—è PII –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—è—Ö
      ['rules','risks','kpis','security','day','cases','automation','priorities','playbooks','guardrails'].forEach(k=>{ data[k] = redactPII(data[k]); });
      data.tasks.forEach(t=>{ t.exceptions = redactPII(t.exceptions||''); t.steps = t.steps.map(s=>redactPII(s)); t.decisions = t.decisions.map(d=>redactPII(d)); });
      data.inputs = data.inputs.map(x=>({ ...x, name:redactPII(x.name||''), source:redactPII(x.source||'') }));
      data.outputs = data.outputs.map(x=>({ ...x, art:redactPII(x.art||''), consumer:redactPII(x.consumer||'') }));
      data.raci = data.raci.map(x=>({ ...x, party:redactPII(x.party||'') }));
      data.systems = (data.systems||[]).map(x=>({ ...x, name:redactPII(x.name||''), owner:redactPII(x.owner||''), access:redactPII(x.access||''), rate_limits:redactPII(x.rate_limits||'') }));
      data.policies = (data.policies||[]).map(x=>({ ...x, channel:redactPII(x.channel||''), escalation_path:redactPII(x.escalation_path||'') }));
      data.metrics = (data.metrics||[]).map(x=>({ ...x, definition:redactPII(x.definition||''), method:redactPII(x.method||'') }));
      data.artifacts, entities, errors, volumes, deps, creds = (data.artifacts, entities, errors, volumes, deps, creds||[]).map(x=>({ ...x, description:redactPII(x.description||''), fileRef:redactPII(x.fileRef||'') }));

      return data;
    }

    function computeReadinessFromTime(time){
      if(!time.length) return 0;
      const w = time.map(r=> (r.mins * (r.score||0)) );
      const totalMins = time.map(r=>r.mins).reduce((a,b)=>a+b,0) || 1;
      return Math.round( w.reduce((a,b)=>a+b,0) / totalMins );
    }

    function updateReadiness(){
      const v = Number(qs('scoreVolume')?.value||0);
      const r = Number(qs('scoreRules')?.value||0);
      const a = Number(qs('scoreAPI')?.value||0);
      const s = Number(qs('scoreSLA')?.value||0);
      const k = Number(qs('scoreRisk')?.value||0);
      const total = Math.round(0.3*v + 0.25*r + 0.2*a + 0.15*s + 0.1*k);
      if(qs('readinessScore')) qs('readinessScore').textContent = total;
      return total;
    }

    function toMarkdown(data){
      const ready = data.readiness?.total || updateReadiness();
      const hdr = `# –û—Ç—á—ë—Ç –ø–æ —Ä–æ–ª–∏: ${data.meta.role||''} ‚Äî ${data.meta.company||''}\n\n` +
                  `**–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:** ${data.meta.dept||''}  \n` +
                  `**–î–∞—Ç–∞ –∏–Ω—Ç–µ—Ä–≤—å—é:** ${data.meta.date||''}  \n` +
                  `**–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä:** ${data.meta.interviewer||''}  \n` +
                  `**–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∑–∞–ø–∏—Å—å:** ${data.meta.consentRecord?'–¥–∞':'–Ω–µ—Ç'}  \n` +
                  `**–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ü–î:** ${data.meta.consentPII?'–¥–∞':'–Ω–µ—Ç'}  \n` +
                  `**–û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏:** ${ready}/100`;

      const tbl = (rows, heads)=>{
        if(!rows.length) return '';
        const head = `| ${heads.join(' | ')} |\n| ${heads.map(()=>'-').join(' | ')} |`;
        const body = rows.map(r=>`| ${heads.map((_,i)=> (r[i]??'').toString().replace(/\n/g,' ')).join(' | ')} |`).join('\n');
        return head + '\n' + body;
      };

      const md = [
        hdr,
        '\n\n## –ö–∞–Ω–∞–ª—ã –∏ —Å–∏—Å—Ç–µ–º—ã\n' + (data.channels||[]).map(c=>'- '+c).join('\n') +
        '\n\n### –°–∏—Å—Ç–µ–º—ã (–¥–µ—Ç–∞–ª–∏)\n' + tbl( (data.systems||[]).map(x=>[x.name,x.type,x.owner,x.access,x.api,x.rate_limits]), ['–°–∏—Å—Ç–µ–º–∞','–¢–∏–ø','–í–ª–∞–¥–µ–ª–µ—Ü','–î–æ—Å—Ç—É–ø—ã','API','–õ–∏–º–∏—Ç—ã'] ),
        '\n\n## –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n' + tbl( data.inputs.map(x=>[x.name,x.source,x.format,x.freq]), ['–ù–∞–∑–≤–∞–Ω–∏–µ','–ò—Å—Ç–æ—á–Ω–∏–∫','–§–æ—Ä–º–∞—Ç','–ß–∞—Å—Ç–æ—Ç–∞'] ),
        '\n\n## –í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã\n' + tbl( data.outputs.map(x=>[x.art,x.consumer,x.format,x.store]), ['–ê—Ä—Ç–µ—Ñ–∞–∫—Ç','–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å','–§–æ—Ä–º–∞—Ç','–•—Ä–∞–Ω–∏–ª–∏—â–µ'] ),
        '\n\n## –ó–∞–¥–∞—á–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã\n' + (data.tasks||[]).map((t,i)=>`### ${i+1}. ${t.title}\n- –¢—Ä–∏–≥–≥–µ—Ä: ${t.trigger}\n- –®–∞–≥–∏:\n${t.steps.map(s=>`  - ${s}`).join('\n')}\n- –†–∞–∑–≤–∏–ª–∫–∏:\n${t.decisions.map(s=>`  - ${s}`).join('\n')}\n- –ò—Å–∫–ª—é—á–µ–Ω–∏—è: ${t.exceptions||'-'}\n- SLA: ${t.sla||'-'}\n- UI –ø–æ–¥—Å–∫–∞–∑–∫–∏:\n${(t.ui_hints||[]).map(s=>`  - ${s}`).join('\n')}`).join('\n\n'),
        '\n\n## –ü–æ–ª–∏—Ç–∏–∫–∏ –∫–∞–Ω–∞–ª–æ–≤\n' + tbl( (data.policies||[]).map(x=>[x.channel,x.inbound_sla,x.followup_cadence,x.max_retries,x.escalation_path,x.quiet_hours,x.tz]), ['–ö–∞–Ω–∞–ª','SLA –≤—Ö–æ–¥–∞','–ö–∞–¥–µ–Ω—Å','–ü–æ–≤—Ç–æ—Ä–æ–≤','–≠—Å–∫–∞–ª–∞—Ü–∏—è','–û–∫–Ω–∞','TZ'] ),
        '\n\n## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∏ RACI\n' + tbl( data.raci.map(x=>[x.party,x.type,x.raci,x.channel]), ['–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç','–¢–∏–ø','RACI','–ö–∞–Ω–∞–ª'] ),
        '\n\n## –¢–∞–π–º-–∞—É–¥–∏—Ç\n' + tbl( data.time.map(x=>[x.task,x.freq,x.mins,x.score]), ['–ó–∞–¥–∞—á–∞','–ß–∞—Å—Ç–æ—Ç–∞','–ú–∏–Ω—É—Ç','–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ–º–æ—Å—Ç—å'] ) +
        '\n\n## –ú–µ—Ç—Ä–∏–∫–∏ –æ–±—ä—ë–º–æ–≤/–≤—Ä–µ–º–µ–Ω–∏\n' + tbl( (data.metrics||[]).map(x=>[x.metric,x.definition,x.units,x.method]), ['–ú–µ—Ç—Ä–∏–∫–∞','–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ','–ï–¥.','–ö–∞–∫ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è'] ),
        '\n\n## –ë–∏–∑–Ω–µ—Å‚Äë–ø—Ä–∞–≤–∏–ª–∞\n' + (data.rules||'-'),
        '\n\n## –†–∏—Å–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è\n' + (data.risks||'-'),
        '\n\n## –ú–µ—Ç—Ä–∏–∫–∏ / KPI\n' + (data.kpis||'-'),
        '\n\n## –î–æ—Å—Ç—É–ø—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\n' + (data.security||'-'),
        '\n\n## –î–µ–Ω—å –∏–∑ –∂–∏–∑–Ω–∏\n' + (data.day||'-'),
        '\n\n## –ù–µ–¥–∞–≤–Ω–∏–µ –∫–µ–π—Å—ã\n' + (data.cases||'-'),
        '\n\n## –ò–¥–µ–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏\n' + (data.automation||'-'),
        '\n\n## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã\n' + (data.priorities||'-') +
        '\n\n## –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã\n' + tbl( (data.artifacts, entities, errors, volumes, deps, creds||[]).map(x=>[x.type,x.fileRef,x.description]), ['–¢–∏–ø','–§–∞–π–ª/–°—Å—ã–ª–∫–∞','–û–ø–∏—Å–∞–Ω–∏–µ'] ) +
        '\n\n## –ö–∞—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–æ\n' + tbl( (data.entities||[]).map(x=>[x.entity,x.desc,x.sor,x.crud_owner,x.pii,x.retention,x.quality]), ['–°—É—â–Ω–æ—Å—Ç—å','–û–ø–∏—Å–∞–Ω–∏–µ','SoR','CRUD','PII','–†–µ—Ç–µ–Ω—Ü–∏—è','–ö–∞—á–µ—Å—Ç–≤–æ'] ) +
        '\n\n## –ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫ –∏ —ç—Å–∫–∞–ª–∞—Ü–∏–π\n' + tbl( (data.errors||[]).map(x=>[x.case,x.detect,x.recover,x.owner,x.notify]), ['–û—à–∏–±–∫–∞','–î–µ—Ç–µ–∫—Ü–∏—è','–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ','–í–ª–∞–¥–µ–ª–µ—Ü','–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è'] ) +
        '\n\n## –û–±—ä—ë–º—ã –∏ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å\n' + tbl( (data.volumes||[]).map(x=>[x.item,x.day,x.week,x.month,x.peaks]), ['–ï–¥–∏–Ω–∏—Ü–∞','–î–µ–Ω—å','–ù–µ–¥–µ–ª—è','–ú–µ—Å—è—Ü','–ü–∏–∫–∏'] ) +
        '\n\n## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –≤–µ–Ω–¥–æ—Ä—ã\n' + tbl( (data.deps||[]).map(x=>[x.dep,x.purpose,x.sla,x.contact,x.risk]), ['–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å','–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ','SLA','–ö–æ–Ω—Ç–∞–∫—Ç','–†–∏—Å–∫'] ) +
        '\n\n## –î–æ—Å—Ç—É–ø—ã –∏ —Å–µ–∫—Ä–µ—Ç—ã\n' + tbl( (data.creds||[]).map(x=>[x.node,x.cred,x.store,x.rotate,x.note]), ['–£–∑–µ–ª/–°–∏—Å—Ç–µ–º–∞','Credential','–•—Ä–∞–Ω–µ–Ω–∏–µ','–†–æ—Ç–∞—Ü–∏—è','–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ'] ) +
        '\n\n## –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–ª–µ–π–±—É–∫–∏\n' + (data.playbooks||'-') +
        '\n\n## –ü—Ä–∞–≤–∏–ª–∞ –∫–æ–ø–∏–ª–æ—Ç–∞ (guardrails)\n' + (data.guardrails||'-') +
        `\n\n## –û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏\n- –û–±—ä—ë–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —à–∞–≥–æ–≤: ${data.readiness?.sliders?.volume ?? '-'}\n- –§–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–∞–≤–∏–ª: ${data.readiness?.sliders?.rules ?? '-'}\n- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API: ${data.readiness?.sliders?.api ?? '-'}\n- SLA/–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: ${data.readiness?.sliders?.sla ?? '-'}\n- –†–∏—Å–∫–∏/–∫–æ–º–ø–ª–∞–µ–Ω—Å: ${data.readiness?.sliders?.risk ?? '-'}\n- –ò—Ç–æ–≥: ${ready}/100`,
      ].join('\n');
      return md;
    }

    function toYAML(data){
      // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è YAML-—Å—Ö–µ–º–∞ –¥–ª—è agentic workflow
      const esc = s=> (s||'').toString().replace(/\n/g,'\\n').replace(/"/g,'\\"');
      const tasks = (data.tasks||[]).map(t=>`  - name: "${esc(t.title)}"\n    trigger: "${esc(t.trigger)}"\n    steps: [${t.steps.map(s=>'"'+esc(s)+'"').join(', ')}]\n    decisions: [${t.decisions.map(s=>'"'+esc(s)+'"').join(', ')}]\n    exceptions: "${esc(t.exceptions)}"\n    sla: "${esc(t.sla)}"\n    ui_hints: [${(t.ui_hints||[]).map(s=>'"'+esc(s)+'"').join(', ')}]`).join('\n');
      const inputs = (data.inputs||[]).map(x=>`  - name: "${esc(x.name)}"\n    source: "${esc(x.source)}"\n    format: "${esc(x.format)}"\n    frequency: "${esc(x.freq)}"`).join('\n');
      const outputs = (data.outputs||[]).map(x=>`  - name: "${esc(x.art)}"\n    consumer: "${esc(x.consumer)}"\n    format: "${esc(x.format)}"\n    storage: "${esc(x.store)}"`).join('\n');
      const raci = (data.raci||[]).map(x=>`  - party: "${esc(x.party)}"\n    interaction: "${esc(x.type)}"\n    role: "${esc(x.raci)}"\n    channel: "${esc(x.channel)}"`).join('\n');
      const time = (data.time||[]).map(x=>`  - task: "${esc(x.task)}"\n    frequency: "${esc(x.freq)}"\n    minutes: ${Number(x.mins)||0}\n    automatable: ${Number(x.score)||0}`).join('\n');
      const systems = (data.systems||[]).map(x=>`  - name: "${esc(x.name)}"\n    type: "${esc(x.type)}"\n    owner: "${esc(x.owner)}"\n    access: "${esc(x.access)}"\n    api_available: "${esc(x.api)}"\n    rate_limits: "${esc(x.rate_limits)}"`).join('\n');
      const policies = (data.policies||[]).map(x=>`  - channel: "${esc(x.channel)}"\n    inbound_sla: "${esc(x.inbound_sla)}"\n    followup_cadence: "${esc(x.followup_cadence)}"\n    max_retries: ${Number(x.max_retries)||0}\n    escalation_path: "${esc(x.escalation_path)}"\n    quiet_hours: "${esc(x.quiet_hours)}"\n    tz: "${esc(x.tz)}"`).join('\n');
      const metrics = (data.metrics||[]).map(x=>`  - metric: "${esc(x.metric)}"\n    definition: "${esc(x.definition)}"\n    units: "${esc(x.units)}"\n    method: "${esc(x.method)}"`).join('\n');
      const artifacts, entities, errors, volumes, deps, creds = (data.artifacts, entities, errors, volumes, deps, creds||[]).map(x=>`  - type: "${esc(x.type)}"\n    file: "${esc(x.fileRef)}"\n    description: "${esc(x.description)}"`).join('\n');
      const readiness = data.readiness ? `readiness:\n  volume: ${Number(data.readiness.sliders?.volume||0)}\n  rules: ${Number(data.readiness.sliders?.rules||0)}\n  api: ${Number(data.readiness.sliders?.api||0)}\n  sla: ${Number(data.readiness.sliders?.sla||0)}\n  risk: ${Number(data.readiness.sliders?.risk||0)}\n  total: ${Number(data.readiness.total||0)}` : 'readiness: {}';
      const yaml = `spec: agentic-workflow-v0.1\nmeta:\n  company: "${esc(data.meta.company)}"\n  dept: "${esc(data.meta.dept)}"\n  role: "${esc(data.meta.role)}"\n  interview_date: "${esc(data.meta.date)}"\n  interviewer: "${esc(data.meta.interviewer)}"\nchannels: [${(data.channels||[]).map(c=>'"'+esc(c)+'"').join(', ')}]\nsystems:\n${systems||'  []'}\ninputs:\n${inputs||'  []'}\noutputs:\n${outputs||'  []'}\nprocesses:\n${tasks||'  []'}\ncomms_policies:\n${policies||'  []'}\nraci:\n${raci||'  []'}\ntime_audit:\n${time||'  []'}\nvolume_metrics:\n${metrics||'  []'}\nartifacts, entities, errors, volumes, deps, creds:\n${artifacts, entities, errors, volumes, deps, creds||'  []'}\nrules: "${esc(data.rules)}"\nrisks: "${esc(data.risks)}"\nkpi: "${esc(data.kpis)}"\nsecurity: "${esc(data.security)}"\nday: "${esc(data.day)}"\ncases: "${esc(data.cases)}"\nautomation: "${esc(data.automation)}"\npriorities: "${esc(data.priorities)}"\n${readiness}\n`;
      return yaml;
    }


      async function genFollowUps(){
        try{
          const data = gather();
          const model = (qs('orModel')?.value||'openrouter/auto').trim();
          const sys = qs('orSys')?.value||'';
          const key = (window.OPENROUTER_API_KEY || localStorage.getItem('OPENROUTER_API_KEY') || '').trim();
          const ctx = {
            meta: { company:data.meta.company, role:data.meta.role, dept:data.meta.dept },
            channels: data.channels,
            systems: data.systems,
            tasks: (data.tasks||[]).map(t=>({ title:t.title, trigger:t.trigger, steps:t.steps.slice(0,5), ui_hints:t.ui_hints||[] })),
            outputs: data.outputs,
            policies: data.policies,
            metrics: data.metrics,
            readiness: data.readiness
          };
          const prompt = `–°—É–º–º–∏—Ä—É–π –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –¥–æ 5 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –¥–∞–Ω–Ω—ã–º:
${JSON.stringify(ctx, null, 2)}
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ 3-5 –ø—É–Ω–∫—Ç–æ–≤.`;

          if(!key){
            qs('followUps').textContent = offlineFollowUps(ctx);
            return;
          }

          const resp = await fetch('https://openrouter.ai/api/v1/chat/completions',{
            method:'POST',
            headers:{
              'Authorization': 'Bearer '+key,
              'Content-Type':'application/json'
            },
            body: JSON.stringify({
              model, messages:[
                {role:'system', content: sys},
                {role:'user', content: prompt}
              ]
            })
          });
          if(!resp.ok){ throw new Error('HTTP '+resp.status); }
          const js = await resp.json();
          const text = js?.choices?.[0]?.message?.content || '(–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞)';
          qs('followUps').textContent = text.trim();
        }catch(e){
          console.warn('LLM error', e);
          try{ qs('followUps').textContent = offlineFollowUps(gather()); }catch{ qs('followUps').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å. –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á OpenRouter –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.'; }
        }
      }

      function offlineFollowUps(ctx){
        const gaps = [];
        if(!(ctx?.tasks||[]).length) gaps.push('–û–ø–∏—à–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–ª—é—á–µ–≤—É—é –∑–∞–¥–∞—á—É —Å —à–∞–≥–∞–º–∏.');
        if(!(ctx?.systems||[]).length) gaps.push('–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–∏—Å—Ç–µ–º—ã, –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –∏ –¥–æ—Å—Ç—É–ø—ã.');
        if(!(ctx?.policies||[]).length) gaps.push('–£—Ç–æ—á–Ω–∏—Ç–µ SLA –∏ –ø–æ–ª–∏—Ç–∏–∫—É —Ñ–æ–ª–ª–æ—É-–∞–ø–æ–≤ –ø–æ –∫–∞–Ω–∞–ª–∞–º.');
        if(!(ctx?.metrics||[]).length) gaps.push('–ö–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –æ–±—ä—ë–º–∞/–≤—Ä–µ–º–µ–Ω–∏ –∏ –∫–∞–∫ –æ–Ω–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è?');
        if((ctx?.readiness?.total||0)<60) gaps.push('–ß—Ç–æ –º–µ—à–∞–µ—Ç –ø–æ–≤—ã—Å–∏—Ç—å –æ—Ü–µ–Ω–∫—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏?');
        const common = [
          '–ü—Ä–∏–≤–µ–¥–∏—Ç–µ 1-2 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ (—à–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞, —ç–∫—Å–ø–æ—Ä—Ç Excel, —Å–∫—Ä–∏–Ω).',
          '–ö–∞–∫–∏–µ –ø–æ–ª—è/—Å–µ–ª–µ–∫—Ç–æ—Ä—ã –Ω—É–∂–Ω—ã –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –∫–ª—é—á–µ–≤—ã—Ö —à–∞–≥–∞—Ö?',
          '–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏ –∫—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ü–µ—Å—Å–∞?',
          '–ö–∞–∫–∏–µ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è API/–ª–∏–º–∏—Ç–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–∏—Å—Ç–µ–º–∞–º?'
        ];
        const list = [...gaps.slice(0,3), ...common.slice(0, 5 - Math.min(3,gaps.length))];
        return list.map((q,i)=>`${i+1}. ${q}`).join('\n');
      }

      async function copyFollowUps(){
        const txt = qs('followUps')?.textContent||'';
        try{ await navigator.clipboard.writeText(txt); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }
        catch{ prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', txt); }
      }

    function exportAll(){
      updateReadiness();
      const data = gather();
      const md = toMarkdown(data);
      const yml = toYAML(data);
      download('role-interview.json', JSON.stringify(data, null, 2));
      download('role-report.md', md);
      download('agentic-workflow.yml', yml);

      const n8n = toN8nJSON(data);
      download('workflow-' + (data.meta.role||'role') + '.json', JSON.stringify(n8n, null, 2));

    }

    function previewMarkdown(){
      const data = gather();
      updateReadiness();
      qs('mdPreview').textContent = toMarkdown(data);
      qs('sec-preview').classList.remove('hidden');
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function download(filename, text){
      const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }

    function saveDraft(){
      const data = gather();
      updateReadiness();
      localStorage.setItem(SKEY, JSON.stringify(data));
      toast('–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');
    }

    function loadDraft(){
      const raw = localStorage.getItem(SKEY); if(!raw){ toast('–ß–µ—Ä–Ω–æ–≤–∏–∫–∞ –Ω–µ—Ç.'); return; }
      applyData(JSON.parse(raw));
      toast('–ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω.');
    }

    function importJSON(ev){
      const f = ev.target.files[0]; if(!f) return;
      const rdr = new FileReader();
      rdr.onload = ()=>{ try{ const obj = JSON.parse(rdr.result); applyData(obj); toast('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ.'); }catch(e){ toast('–û—à–∏–±–∫–∞ JSON.'); } };
      rdr.readAsText(f);
    }

    function applyData(data){
      // –º–µ—Ç–∞
      ['company','dept','role','employee','interviewer','date'].forEach(id=>{ if(data.meta&&data.meta[id]!=null) qs(id).value = data.meta[id]; });
      if(data.meta){ qs('consentRecord').checked = !!data.meta.consentRecord; qs('consentPII').checked = !!data.meta.consentPII; qs('redact').checked = !!data.meta.redact; }

      // –∫–∞–Ω–∞–ª—ã
      qs('channelsBox').innerHTML='';
      (defaultChannels).forEach(c=> addChannelChip(c, data.channels?.includes(c)));
      (data.channels||[]).forEach(c=>{ if(!defaultChannels.includes(c)) addChannelChip(c, true); });

      // tables
      qs('inputsBody').innerHTML=''; (data.inputs||[]).forEach(r=>addRow('inputs', r));
      qs('outputsBody').innerHTML=''; (data.outputs||[]).forEach(r=>addRow('outputs', r));
      qs('systemsBody').innerHTML=''; (data.systems||[]).forEach(r=>addRow('systems', r));
      qs('policiesBody').innerHTML=''; (data.policies||[]).forEach(r=>addRow('policies', r));
      qs('metricsBody').innerHTML=''; (data.metrics||[]).forEach(r=>addRow('metrics', r));
      qs('raciBody').innerHTML=''; (data.raci||[]).forEach(r=>addRow('raci', r));
      qs('timeBody').innerHTML=''; (data.time||[]).forEach(r=>addRow('time', r)); recalcTime();
      qs('artifacts, entities, errors, volumes, deps, credsBody').innerHTML=''; (data.artifacts, entities, errors, volumes, deps, creds||[]).forEach(r=>addRow('artifacts, entities, errors, volumes, deps, creds', r));

      // tasks
      qs('tasksBox').innerHTML=''; taskCount=0; (data.tasks||[]).forEach(t=>addTask(t));

      // text areas
      ['rules','risks','kpis','security','day','cases','automation','priorities','playbooks','guardrails'].forEach(id=>{ if(data[id]!=null) qs(id).value = data[id]; });

      // readiness sliders
      if(data.readiness && data.readiness.sliders){
        if(qs('scoreVolume')) qs('scoreVolume').value = data.readiness.sliders.volume||0;
        if(qs('scoreRules')) qs('scoreRules').value = data.readiness.sliders.rules||0;
        if(qs('scoreAPI')) qs('scoreAPI').value = data.readiness.sliders.api||0;
        if(qs('scoreSLA')) qs('scoreSLA').value = data.readiness.sliders.sla||0;
        if(qs('scoreRisk')) qs('scoreRisk').value = data.readiness.sliders.risk||0;
        updateReadiness();
      }

      rebuildDiagramSelector();
    }

    function toast(msg){
      const d = document.createElement('div');
      d.textContent = msg; d.className = 'fixed bottom-4 right-4 bg-black bg-opacity-80 text-white px-3 py-2 rounded-lg';
      document.body.appendChild(d); setTimeout(()=>d.remove(), 2500);
    }

    // ‚Äî –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî
    (function init(){
      defaultChannels.forEach(c=> addChannelChip(c));
      addRow('inputs'); addRow('outputs'); addRow('systems'); addRow('policies'); addRow('metrics'); addRow('raci'); addRow('time'); addRow('artifacts, entities, errors, volumes, deps, creds');
      addTask({ title:'–û—Ç–≤–µ—Ç –Ω–∞ –≤—Ö–æ–¥—è—â–µ–µ –ø–∏—Å—å–º–æ –∫–ª–∏–µ–Ω—Ç–∞', trigger:'–ü–æ–ª—É—á–µ–Ω e‚Äëmail —Å –≤–æ–ø—Ä–æ—Å–æ–º', steps:'1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–∏—Å—å–º–æ\n2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –≤ CRM\n3. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –ø–æ —à–∞–±–ª–æ–Ω—É', decisions:'–ï—Å—Ç—å –Ω–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞?\n–ï—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Å—á–µ—Ç?', ui:'URL=/crm; —Å–µ–ª–µ–∫—Ç–æ—Ä—ã=.reply-btn' });
      recalcTime(); rebuildDiagramSelector(); updateReadiness();
    })();
  
    function toN8nJSON(data){
      // Very simplified generator: one trigger per first policy (CRON or email), steps as Code nodes
      const nodes = [];
      let id = 1;
      function nid(){ return (id++).toString(); }

      // Trigger (fallback to Cron every day 9:00)
      let trigger = { id: nid(), name:'Trigger', type:'n8n-nodes-base.cron', parameters:{ rule:'0 9 * * *' } };
      const emailPol = (data.policies||[]).find(p=> (p.channel||'').toLowerCase().includes('mail'));
      if(emailPol){
        trigger = { id: nid(), name:'Email Trigger', type:'n8n-nodes-base.imapTrigger', parameters:{} };
      }
      nodes.push(trigger);

      let prev = trigger.id;
      (data.tasks||[]).forEach((t,i)=>{
        const code = [
          `// ${t.title}`,
          `// Trigger: ${t.trigger}`,
          `// Steps: ${ (t.steps||[]).join(' | ') }`,
          `// Decisions: ${ (t.decisions||[]).join(' | ') }`,
          `// Exceptions: ${ t.exceptions||'' }`,
        ].join('\n');
        const node = { id:nid(), name:`Step ${i+1}: ${t.title||'Task'}`, type:'n8n-nodes-base.code', parameters:{ language:'javascript', code } };
        nodes.push(node);
      });

      // Simple notify at the end using SMTP if any policy exists
      const notify = { id:nid(), name:'Notify', type:'n8n-nodes-base.smtp', parameters:{ to:'owner@example.com', subject:'Workflow finished', text:'Done' } };
      nodes.push(notify);

      // Build linear connections
      const connections = {};
      function link(a,b){
        connections[a] = connections[a] || { main: [[]] };
        connections[a].main[0].push({ node:b, type:'main', index:0 });
      }
      let chain = [trigger.id].concat(nodes.filter(n=>n!==trigger && n.name.startsWith('Step')).map(n=>n.id)).concat([notify.id]);
      for(let i=0;i<chain.length-1;i++){ link(chain[i], chain[i+1]); }

      return { nodes, connections, meta: { generatedBy:'FlowXray', ts: new Date().toISOString() } };
    }

</script>

<script>
(function(){
  const qs = (id)=>document.getElementById(id);
  // Wrap existing addRow to extend behavior without removing original
  const _origAddRow = window.addRow;
  window.addRow = function(kind, data={}){
    if(typeof _origAddRow === 'function'){ try{ _origAddRow(kind, data); }catch(e){} }
    if(kind==='systems'){
      const body = qs('systemsBody');
      if(body && (!body.querySelector('tr') || (data && data._force))){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–°–∏—Å—Ç–µ–º–∞ (CRM, ERP,...)" value="${data.name||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–¢–∏–ø (CRM/ERP/–•—Ä–∞–Ω–∏–ª–∏—â–µ)" value="${data.type||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–í–ª–∞–¥–µ–ª–µ—Ü/Owner" value="${data.owner||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–†–æ–ª–∏/–î–æ—Å—Ç—É–ø—ã" value="${data.access||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="API (–µ—Å—Ç—å?/—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã)" value="${data.api||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–õ–∏–º–∏—Ç—ã/Rate limits" value="${data.limits||''}"></td>
          <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        body.appendChild(tr);
      }
    }
    if(kind==='policies'){
      const body = qs('policiesBody');
      if(body && (!body.querySelector('tr') || (data && data._force))){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–ö–∞–Ω–∞–ª (email/—Ç–µ–ª–µ—Ñ–æ–Ω/—á–∞—Ç/...)" value="${data.channel||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="SLA –≤—Ö–æ–¥–∞ (–Ω–∞–ø—Ä. 4—á)" value="${data.inSla||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–ö–∞–¥–µ–Ω—Å —Ñ–æ–ª–ª–æ—É-–∞–ø–∞ (24—á, 72—á)" value="${data.cadence||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–ú–∞–∫—Å. —Ä–µ—Ç—Ä–∞–µ–≤" value="${data.retries||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–≠—Å–∫–∞–ª–∞—Ü–∏—è (–∫–æ–º—É/–∫—É–¥–∞)" value="${data.escalation||''}"></td>
          <td><input class="w-full bg-gray-900 border border-gray-700 rounded p-1" placeholder="–û–∫–Ω–∞ —Ç–∏—à–∏–Ω—ã (–Ω–µ –∑–≤–æ–Ω–∏—Ç—å)" value="${data.quiet||''}"></td>
          <td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        body.appendChild(tr);
      }
    }
  };

  // On DOM ready: ensure at least one row exists in 2a/2b
  function ensureInitialRows(){
    const bodies = [['systemsBody','systems'], ['policiesBody','policies']];
    bodies.forEach(([id, kind])=>{
      const el = qs(id);
      if(el && !el.querySelector('tr')){
        window.addRow(kind, {_force:true});
      }
    });
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureInitialRows);
  } else {
    ensureInitialRows();
  }
})();
</script>


<!-- AI suggestion modal -->
<div id="suggestModal" role="dialog" aria-modal="true">
  <div class="panel">
    <h3 class="text-lg font-semibold">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (AI)</h3>
    <p class="small-hint">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫.</p>
    <div id="suggestList"></div>
    <div class="actions">
      <button class="btn" id="suggestAdd">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
      <button class="btn-ghost" id="suggestCancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>


<script>
(function(){
  const _oldAdd = window.addRow;
  window.addRow = function(kind, data={}){
    if(typeof _oldAdd === 'function'){ try{ _oldAdd(kind, data);}catch(e){} }
    const mk = (v='')=>`<input class="w-full bg-gray-900 border border-gray-700 rounded p-1" value="${(v??'').toString().replace(/"/g,'&quot;')}">`;
    if(kind==='inputs'){
      const body = document.getElementById('inputsBody');
      if(body){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${mk(data.name)}</td><td>${mk(data.source_system)}</td><td>${mk(data.format)}</td><td>${mk(data.frequency)}</td><td>${mk(data.sla_expected||'')}</td><td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        body.appendChild(tr);
      }
    }
    if(kind==='outputs'){
      const body = document.getElementById('outputsBody');
      if(body){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${mk(data.name)}</td><td>${mk(data.consumer)}</td><td>${mk(data.template_ref)}</td><td>${mk(data.storage)}</td><td>${mk(data.due)}</td><td>${mk(data.quality_checks)}</td><td><button class="btn" onclick="this.closest('tr').remove()">‚úñ</button></td>`;
        body.appendChild(tr);
      }
    }
  };

  function ensureSeed(){
    const seeds = ['systemsBody','policiesBody','inputsBody','outputsBody','metricsBody','raciBody','timeBody','artifactsBody'];
    seeds.forEach(id=>{
      const el = document.getElementById(id);
      if(el && !el.querySelector('tr')){
        const map = {
          systemsBody:'systems',
          policiesBody:'policies',
          inputsBody:'inputs',
          outputsBody:'outputs',
          metricsBody:'metrics',
          raciBody:'raci',
          timeBody:'time',
          artifactsBody:'artifacts'
        };
        window.addRow(map[id], {_force:true});
      }
    });
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', ensureSeed); } else { ensureSeed(); }

  // --- AI assisted suggestions ---
  const presets = {
    sales: { systems:['Salesforce','HubSpot','Pipedrive','Zoho CRM','Freshsales'], inputs:['email','web lead form','phone call','LinkedIn message'], outputs:['proposal (PDF)','quote','calendar invite','CRM note'] },
    support: { systems:['Zendesk','Freshdesk','Jira Service Management','Intercom','ServiceNow'], inputs:['ticket','email','chat','phone'], outputs:['knowledge base article','ticket resolution','SLA report'] },
    accounting: { systems:['DATEV','SAP FI','1C','QuickBooks','Xero'], inputs:['invoice (PDF)','bank feed','PO','expense report'], outputs:['payment order','VAT report','reconciliation'] },
    development: { systems:['GitHub','GitLab','Jenkins','CircleCI','Jira'], inputs:['issue','PR','build failed alert'], outputs:['release notes','artifact','deployment'] },
    marketing: { systems:['GA4','Search Console','Facebook Ads','Google Ads','Mailchimp'], inputs:['campaign brief','csv leads','utm report'], outputs:['campaign report','newsletter','landing page brief'] },
    hr: { systems:['Greenhouse','Lever','Workable','BambooHR','Personio'], inputs:['resume','candidate note','interview scorecard'], outputs:['offer letter','onboarding checklist'] }
  };

  function getMeta(){
    try{
      if(typeof window.gather === 'function'){
        const d = window.gather();
        return (d && d.meta) ? d.meta : {};
      }
    }catch(e){}
    const role = (document.getElementById('role')||{}).value || '';
    const dept = (document.getElementById('dept')||{}).value || '';
    const company = (document.getElementById('company')||{}).value || '';
    return { role, dept, company };
  }

  function addToolbar(secId, handler){
    const sec = document.getElementById(secId);
    if(!sec) return;
    const bar = document.createElement('div');
    bar.className = 'toolbar';
    const btn = document.createElement('button');
    btn.className = 'btn-ghost';
    btn.type = 'button';
    btn.textContent = '‚ö° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã (AI)';
    btn.onclick = handler;
    const keyBtn = document.createElement('button');
    keyBtn.className = 'btn-ghost';
    keyBtn.textContent = 'üîë API –∫–ª—é—á';
    keyBtn.onclick = ()=>{
      const k = prompt('–í—Å—Ç–∞–≤—å—Ç–µ OpenRouter API Key (–±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ localStorage)');
      if(k){ localStorage.setItem('OPENROUTER_API_KEY', k.trim()); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.'); }
    };
    const hint = document.createElement('span');
    hint.className = 'small-hint';
    hint.textContent = '–ù–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–∏/–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ–∫–∞–∂–µ–º –≤–µ—Ä–æ—è—Ç–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã, –≤—Ö–æ–¥—ã/–≤—ã—Ö–æ–¥—ã.';
    bar.append(btn,keyBtn,hint);
    const title = sec.querySelector('.section-title');
    if(title){ title.after(bar); } else { sec.prepend(bar); }
  }

  addToolbar('sec-systems', suggestSystems);
  addToolbar('sec-inputs', suggestInputs);
  addToolbar('sec-outputs', suggestOutputs);

  async function openRouterSuggest(kind, meta){
    const key = localStorage.getItem('OPENROUTER_API_KEY');
    if(!key) return null;
    const prompt = `Role: ${meta.role||''}; Department: ${meta.dept||''}; Company: ${meta.company||''}. `+
                   `Return JSON keys for ${kind} likely used in this role/department in Germany/EU SMBs. `+
                   `For systems include {name,type?}. For inputs include array of strings. For outputs include array of strings. `+
                   `Example: {"systems":[{"name":"HubSpot","type":"CRM"}],"inputs":["email"],"outputs":["proposal (PDF)"]}.`;
    try{
      const r = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization': 'Bearer ' + key,
          'HTTP-Referer': location.origin,
          'X-Title':'FlowXray Form'
        },
        body: JSON.stringify({
          model: 'openrouter/auto',
          messages: [
            {role:'system', content:'You return clean, minimal JSON only. No prose.'},
            {role:'user', content: prompt}
          ]
        })
      });
      const j = await r.json();
      const txt = j.choices?.[0]?.message?.content || '[]';
      try{ return JSON.parse(txt); }catch(_){ return null; }
    }catch(e){ return null; }
  }

  function showSuggest(items, onApply){
    const modal = document.getElementById('suggestModal');
    const list = document.getElementById('suggestList');
    const ok = document.getElementById('suggestAdd');
    const cancel = document.getElementById('suggestCancel');
    list.innerHTML = '';
    items.forEach(obj=>{
      const label = document.createElement('label');
      const cb = document.createElement('input'); cb.type='checkbox'; cb.value = obj.value || obj.name || obj;
      const span = document.createElement('span'); span.textContent = obj.label || obj.name || obj;
      label.append(cb, span);
      list.append(label);
    });
    modal.style.display='flex';
    ok.onclick = ()=>{
      const chosen = Array.from(list.querySelectorAll('input[type=checkbox]:checked')).map(x=>x.value);
      modal.style.display='none';
      onApply(chosen);
    };
    cancel.onclick = ()=>{ modal.style.display='none'; };
  }

  async function suggestSystems(){
    const meta = getMeta();
    const roleKey = (meta.role||'').toLowerCase();
    const local = (presets[roleKey] && presets[roleKey].systems) || presets.sales.systems;
    const remote = await openRouterSuggest('systems', meta);
    const items = (remote?.systems || local).map(x=> (typeof x==='string' ? {name:x} : x));
    showSuggest(items.map(x=>({name:x.name||x, value:x.name||x})), chosen=>{
      chosen.forEach(v=> window.addRow('systems', {name:v,type:'',owner:'',access:'',api:'',limits:''}) );
    });
  }
  async function suggestInputs(){
    const meta = getMeta();
    const roleKey = (meta.role||'').toLowerCase();
    const local = (presets[roleKey] && presets[roleKey].inputs) || presets.sales.inputs;
    const remote = await openRouterSuggest('inputs', meta);
    const items = (remote?.inputs || local);
    showSuggest(items.map(x=>({name:x, value:x})), chosen=>{
      chosen.forEach(v=> window.addRow('inputs', {name:v,source_system:'',format:'',frequency:'',sla_expected:''}) );
    });
  }
  async function suggestOutputs(){
    const meta = getMeta();
    const roleKey = (meta.role||'').toLowerCase();
    const local = (presets[roleKey] && presets[roleKey].outputs) || presets.sales.outputs;
    const remote = await openRouterSuggest('outputs', meta);
    const items = (remote?.outputs || local);
    showSuggest(items.map(x=>({name:x, value:x})), chosen=>{
      chosen.forEach(v=> window.addRow('outputs', {name:v,consumer:'',template_ref:'',storage:'',due:'',quality_checks:''}) );
    });
  }
})();
</script>

</body>
</html>
